# Phase 8: 統合テスト計画

## 概要
ProblemViewEditPage での完全な統合テストを実行し、以下の機能を検証します：

1. Edit/View モード切り替え
2. コンテンツ変更検出
3. トースト警告 UI
4. 各ボタン機能（SAVE/UNSAVE/CANCEL）

---

## テストシナリオ 1: Edit モード切り替え

### 前提条件
- ブラウザで http://localhost:5173 を開く
- ProblemViewEditPage に遷移（問題編集ページ）
- 現在のモード：View（閲覧モード）

### テスト手順
1. TopMenuBar の「View」ボタンを確認
2. 「Edit」ボタンを押す
3. ページのコンテンツがエディタモードに切り替わることを確認

### 期待結果
✅ 質問ブロックの編集フォーム（エディタパネル）が表示される
✅ 各フィールドが編集可能になる
✅ TopMenuBar に「Preview」ボタンが表示される（View ボタンから切り替わる）

---

## テストシナリオ 2: 変更検出と SAVE ボタン有効化

### 前提条件
- Edit モードで ProblemViewEditPage を表示
- SAVE ボタン：現在 disabled
- TopMenuBar 右側を確認

### テスト手順
1. 質問のコンテンツ（問題文）を編集する
   - 編集フォーム内のテキストを変更
2. SAVE ボタンの状態を確認
3. テキストを元に戻す

### 期待結果
✅ コンテンツを変更 → SAVE ボタンが enabled になる
✅ コンテンツを元に戻す → SAVE ボタンが disabled になる
✅ 変更がない場合：SAVE ボタンは disabled

---

## テストシナリオ 3: トースト警告 UI の表示

### 前提条件
- Edit モードで何か変更を加えた状態
- SAVE ボタン：enabled 状態
- 別のページへのナビゲーションリンクを用意

### テスト手順
1. 質問のコンテンツを編集（例：文字を追加）
2. 保存せずに別ページへ遷移しようとする
   - TopMenuBar のロゴをクリック（ホームへ）
   - または左のドロワーで別ページを選択

### 期待結果
✅ トースト警告が表示される
  - 位置：画面上部中央
  - テキスト：「未保存の変更があります。保存して移動しますか？」
  - 背景色：ブラウザデフォルト（白/ライトグレー）
  - 上部に primary色のボーダー表示

✅ 3つのボタンが表示される：
  - [SAVE]：Primary 色（青）
  - [UNSAVE]：Error 色（赤）
  - [CANCEL]：グレー（normal）

---

## テストシナリオ 4: SAVE ボタンの動作

### 前提条件
- トースト警告が表示されている状態
- [SAVE] ボタンをクリック可能

### テスト手順
1. トースト警告の [SAVE] ボタンをクリック
2. 処理完了を待つ（「保存中...」表示が消える）
3. ページがホームに遷移することを確認

### 期待結果
✅ [SAVE] ボタンがクリック時に disabled 状態に
✅ ボタンテキストが「保存中...」に変更
✅ SubQuestion の save() メソッドが実行される
✅ API 保存が完了後、指定されたページに遷移
✅ トースト警告が自動的に閉じる

---

## テストシナリオ 5: UNSAVE ボタンの動作

### 前提条件
- Edit モードで変更を加えた状態
- トースト警告が表示されている

### テスト手順
1. 質問のコンテンツを編集
2. 保存せずに別ページへ遷移しようとする
3. トースト警告が表示されたら [UNSAVE] ボタンをクリック

### 期待結果
✅ [UNSAVE] ボタンをクリック
✅ 保存処理を実行しない（API コールなし）
✅ 即座に別ページへ遷移
✅ 編集内容が破棄される
✅ トースト警告が閉じる

---

## テストシナリオ 6: CANCEL ボタンの動作

### 前提条件
- Edit モードで変更を加えた状態
- トースト警告が表示されている

### テスト手順
1. 質問のコンテンツを編集
2. 保存せずに別ページへ遷移しようとする
3. トースト警告が表示されたら [CANCEL] ボタンをクリック

### 期待結果
✅ [CANCEL] ボタンをクリック
✅ ナビゲーションが中止される
✅ トースト警告が閉じる
✅ ページが元のままで、編集を継続できる

---

## テストシナリオ 7: Preview モード（変更なし）

### 前提条件
- ProblemViewEditPage を View（Preview）モードで表示

### テスト手順
1. Preview モードの表示を確認
2. 別のページへ遷移を試みる

### 期待結果
✅ 編集フォームが表示されない（プレビューのみ）
✅ 無駄なスペースがない
✅ ナビゲーション時に警告が表示されない（hasChanges = false）

---

## テストシナリオ 8: 複数質問の同時編集

### 前提条件
- Edit モードで複数の質問（Question）が表示
- 各質問には SubQuestion が存在

### テスト手順
1. 複数の質問のコンテンツを編集
2. 変更状態を確認
3. SAVE ボタンをクリック

### 期待結果
✅ すべての質問の編集フォームが表示される
✅ SAVE ボタンをクリック時にすべての SubQuestion.save() が並列実行（Promise.all）
✅ すべての保存処理が完了後に成功メッセージが表示される

---

## チェックリスト

### UI/UX
- [ ] トースト警告の位置が画面上部中央
- [ ] トースト警告の背景色がブラウザデフォルト色
- [ ] ボタン色が統一（SAVE: primary, UNSAVE: error, CANCEL: normal）
- [ ] Edit/View 切り替え時の UI が即座に更新
- [ ] Preview モード時に無駄なスペースがない

### 機能
- [ ] Edit ボタン押下 → isEditModeLocal が更新
- [ ] hasChanges が isEditModeLocal に依存
- [ ] 変更なし → SAVE ボタン disabled
- [ ] 変更あり → SAVE ボタン enabled
- [ ] SAVE → API 保存 → ナビゲーション
- [ ] UNSAVE → 保存なし → ナビゲーション
- [ ] CANCEL → ナビゲーション中止 → 編集継続

### パフォーマンス
- [ ] SAVE 実行時に複数 SubQuestion が並列で保存
- [ ] API レスポンス時間が妥当（3秒以内）
- [ ] エラー発生時に Alert が表示される

---

## トラブルシューティング

### 問題: Edit ボタンを押しても編集フォームが表示されない

**原因候補:**
- isEditMode コンテキストが更新されていない
- useEffect の同期が失敗している

**確認方法:**
1. ブラウザのコンソール開く（F12）
2. React Developer Tools で AppBarActionContext の値を確認
3. isEditMode が true に更新されているか確認

### 問題: SAVE ボタンが常に disabled のまま

**原因候補:**
- hasChanges が常に false
- isEditModeLocal が false のまま

**確認方法:**
1. コンソールで `console.log(hasChanges, isEditModeLocal)` を追加
2. 値の変化をリアルタイム監視

### 問題: トースト警告が表示されない

**原因候補:**
- showWarningSnackbar が false のまま
- handleNavigation が正しく動作していない

**確認方法:**
1. ProblemViewEditPage のナビゲーション処理を確認
2. TopMenuBar の handleNavigation を確認

---

## 次のステップ（Phase 9）

テスト完了後：
1. エラーハンドリングの強化
2. 自動保存機能の実装（オプション）
3. 競合検出と解決の実装（オプション）
4. 他のページへの適用（MyPage など）
